---
title: "Take-home Ex04"
author: "Li Ziyi"
date: 17 February 2023
date-modified: "`r Sys.Date()`"
execute:
  echo: true
  eval: true
  warning: false
format: html
editor: visual
---

# Overview

For this assignment, the impact of COVID-19 as well as the global economic and political dynamic in 2022 on Singapore bi-lateral trade will be uncovered with visual analytics. Dataset is taken from [Department of Statistics Singapore](https://www.singstat.gov.sg/find-data/search-by-theme/trade-and-investment/merchandise-trade/latest-data).


## (TO UPDATE) Loading libraries

For this exercise,

-   tidyverse is the main package to be used for data processing

-   DT is the package to be used for interactive data preview

-   ggstatsplot is the packge to be used for statistical analysis and visualisation

-   ggiraph, gganimate and gifski are packages to enable interactive data visualisation

-   Other packages are for make-up mainly

```{r}
pacman::p_load(tidyverse,
               DT,
               readxl,
               ggiraph,
               gganimate,
               ggthemes,
               remotes,
               ggbraid)
```

## Data loading

```{r}
trade_export_temp <- read_excel("Data/Merchandise trade by region_market.xlsx",
                       sheet = "T1") 

trade_import_temp <- read_excel("Data/Merchandise trade by region_market.xlsx",
                       sheet = "T2") 

head(trade_import_temp)
```


```{r}
colnames(trade_import_temp) <- as.character(unlist(trade_import_temp[9,]))
colnames(trade_export_temp) <- as.character(unlist(trade_export_temp[9,]))

head(trade_export_temp)
```


```{r}
trade_export_temp <- trade_export_temp[c(11:(nrow(trade_export_temp)-23)),]
export_vector <- rep("Export",
                     nrow(trade_export_temp))

trade_export_temp$trade <- export_vector
head(trade_export_temp)
```


```{r}
trade_import_temp <- trade_import_temp[c(11:(nrow(trade_import_temp)-23)),]
import_vector <- rep("Import",
                     nrow(trade_import_temp))

trade_import_temp$trade <- import_vector
head(trade_import_temp)
```


```{r}

names(trade_export_temp)[1] <- "Market_"
names(trade_import_temp)[1] <- "Market_"

head(trade_export_temp)
```

```{r}
trade_export_unpiv <- trade_export_temp[,c(1, 3:14, ncol(trade_export_temp))]

head(trade_export_unpiv)
```
```{r}
trade_import_unpiv <- trade_import_temp[,c(1, 3:14, ncol(trade_import_temp))]

head(trade_import_unpiv)
```

```{r}
trade_full <- rbind(trade_export_unpiv,
                    trade_import_unpiv)

head(trade_full)
```
```{r}
trade_full_unpivot <- gather(trade_full, key = "Month_", value = "Trade_Amount", -Market_, -trade)

head(trade_full_unpivot)
```
```{r}
trade_full_unpivot$`Trade_Amount` <- as.numeric(trade_full_unpivot$`Trade_Amount`)

trade_full_unpivot$`Trade_Amount` <- ifelse(grepl("Thousand Dollars", trade_full_unpivot$Market_), trade_full_unpivot$'Trade_Amount' * 1000, trade_full_unpivot$'Trade_Amount' * 1000000)


head(trade_full_unpivot)
```
```{r}
trade_full_unpivot$Market_ <- gsub(" \\(Thousand Dollars\\)|\\(Million Dollars\\)", "", trade_full_unpivot$Market_)

head(trade_full_unpivot)
```
```{r}
unique(trade_full_unpivot$Month_)
```

```{r}
trade_clean <- 
separate(trade_full_unpivot,
         Month_,
         into = c("Year", "Month"),
         sep = " ",
         convert = TRUE,
         remove = TRUE)

head(trade_clean)
```

```{r}
trade_clean$Trade_Amount <- ifelse(is.na(trade_clean$Trade_Amount), 0, trade_clean$Trade_Amount)
```


```{r}
trade_region <- trade_clean %>% 
  filter(trimws(Market_) %in% c("America", "Asia", "Europe", "Oceania", "Africa", "European Union"))

head(trade_region)
```


```{r}
#| fig-width: 12
#| label: fig-barchart
#| fig-cap: trade_by_region
trade_region$Market_ <- 
  reorder(trade_region$Market_,
          -trade_region$Trade_Amount)


p1 <- ggplot(trade_region,
           aes(x = factor(Market_),
               y = Trade_Amount,
               fill = trade)) +
  geom_bar(position = "dodge",
           stat = "identity") +
  labs(title = "$ Amount of bi-lateral trade in Singapore by Markets in 2022",
       x = "Market",
       y = "$ Amount",
       fill = "Trade type") + 
  theme_economist() +
  theme(axis.title.y = element_text(vjust = 2.5,
                                    size = 12),
        axis.title.x = element_text(vjust = -2.5,
                                    size = 12))

p1
  
  
```

```{r}
# calculate trade surplus/deficit
trade_balance <- trade_clean %>%
  group_by(Market_, Month, trade) %>%
  summarize(Trade_Balance = sum(Trade_Amount)) %>%
  spread(key = trade, value = Trade_Balance, fill = 0) %>% 
  mutate(Surplus_Deficit = Export - Import)

```



```{r}
install_github("nsgrantham/ggbraid")
```
```{r}
month_order <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                 "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
trade_balance$Month <- factor(trade_balance$Month, levels = month_order)


```

```{r}
#| eval = FALSE
# create braid plot
ggplot(trade_balance,
       aes(x = Month,
           y = Surplus_Deficit, 
           fill = Market_)) +
  geom_braid(aes(size = abs(Surplus_Deficit),
                 color = Surplus_Deficit > 0)) +
  geom_ribbon(aes(ymin = 0, 
                  ymax = Surplus_Deficit, 
                  fill = Surplus_Deficit > 0), alpha = 0.2) +
  facet_wrap(~Market_, ncol = 4) +
  scale_size(range = c(1, 5)) +
  scale_fill_manual(values = c("blue", "red")) +
  scale_color_manual(values = c("blue", "red")) +
  coord_flip() +
  labs(title = "Trade Surplus/Deficit by Market",
       x = "", 
       y = "") +
  theme_economist() +
  theme(legend.position = "bottom")





```

```{r}
ggplot(trade_balance, 
       aes(x = Month, 
           y = Surplus_Deficit, 
           color = Surplus_Deficit > 0)) +
  geom_line(aes(linetype = Surplus_Deficit > 0)) +
  scale_color_manual(values = c("red", "blue")) +
  scale_linetype_manual(values = c("dashed", "solid")) +
  facet_wrap(~ Market_, ncol = 4) +

  # labs(title = "Trade Surplus/Deficit by Market",
  #      x = "",
  #      y = "") +
  theme_economist() +
  theme(legend.position = "bottom")


```


```{r}
trade_balance3 <- trade_balance %>% 
  filter(Market_ %in% c("America ", "Asia ")) %>% 
ggplot(
       aes(x = Month,
           y = Surplus_Deficit, 
           )) +
  geom_col() +
    # geom_braid(aes(size = abs(Surplus_Deficit),
  #                color = Surplus_Deficit > 0)) +
  # geom_ribbon(aes(ymin = 0, 
  #                 ymax = Surplus_Deficit, 
  #                 fill = Surplus_Deficit > 0), alpha = 0.2) +
  facet_wrap(~Market_)

trade_balance3
```
